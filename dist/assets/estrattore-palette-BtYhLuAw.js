let X=!1;function at(){if(X)return;X=!0;const d=e=>document.getElementById(e),D=e=>e.toString(16).padStart(2,"0"),L=({r:e,g:t,b:n})=>"#"+D(e)+D(t)+D(n);function P(e,t,n){e/=255,t/=255,n/=255;const a=Math.max(e,t,n),r=Math.min(e,t,n);let s,h,l=(a+r)/2;if(a===r)s=h=0;else{const i=a-r;switch(h=l>.5?i/(2-a-r):i/(a+r),a){case e:s=(t-n)/i+(t<n?6:0);break;case t:s=(n-e)/i+2;break;default:s=(e-t)/i+4}s/=6}return{h:Math.round(360*s),s:Math.round(100*h),l:Math.round(100*l)}}function N({r:e,g:t,b:n}){const a=[e,t,n].map(r=>r/255).map(r=>r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4));return .2126*a[0]+.7152*a[1]+.0722*a[2]}function y(e,t){const n=N(e),a=N(t);return(Math.max(n,a)+.05)/(Math.min(n,a)+.05)}function A(e){const t={r:255,g:255,b:255},n={r:0,g:0,b:0},a=y(e,t),r=y(e,n);return a>=r?{hex:"#ffffff",ratio:a,rgb:t}:{hex:"#000000",ratio:r,rgb:n}}function Y(e){let t=e.replace("#","");return t.length===3&&(t=t.split("").map(n=>n+n).join("")),{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16)}}const v=d("file"),p=d("drop"),w=d("thumb"),k=d("analyze"),z=d("info-dim"),F=d("avg-bar"),W=d("avg-val"),H=d("palette"),I={bg:d("role-bg"),primary:d("role-primary"),accent:d("role-accent"),text:d("role-text")},b=d("grads"),m=d("export-info"),E=d("diag"),R=d("copy-css"),j=d("copy-json"),G=d("dl-css"),U=d("dl-json"),q=d("demo"),O=d("reset");let c=[],g=null;function S(e){w&&(w.innerHTML=`<img alt="Anteprima immagine" src="${e}"/>`)}function V(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=n,a.readAsDataURL(e)})}function C(e,t){const n=new Blob([t],{type:"text/plain"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download=e,a.click(),setTimeout(()=>URL.revokeObjectURL(a.href),1e3)}async function T(e){try{if(!navigator.clipboard||!window.isSecureContext)throw new Error("clipboard non disponibile");return await navigator.clipboard.writeText(e),{ok:!0,method:"clipboard"}}catch{try{const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select(),t.setSelectionRange(0,t.value.length);const n=document.execCommand("copy");if(document.body.removeChild(t),!n)throw new Error("execCommand fallito");return{ok:!0,method:"execCommand"}}catch(t){return{ok:!1,error:t}}}}function _(e,t,n,a){const r=document.createElement("div");return r.className="grad-pill",r.setAttribute("role","button"),r.tabIndex=0,r.innerHTML=`
      <span class="grad-chip" style="background:${t}"></span>
      <span class="label">${e}</span>
      <span class="grad-chip" style="background:${n}"></span>
    `,r.style.background=`linear-gradient(90deg, ${t}, ${n})`,r.style.color=A(Y(t)).hex,r.dataset.from=t,r.dataset.to=n,r.dataset.label=e,r.title=(a||e)+" — "+t+" → "+n+" (clicca per copiare CSS)",r}function J(){if(!c.length)return"";const e=[":root {"];return c.forEach((t,n)=>e.push(`  --color-${n+1}: ${t.hex};`)),g&&e.push(`  --bg: ${g.bg.hex};`,`  --primary: ${g.primary.hex};`,`  --accent: ${g.accent.hex};`,`  --text: ${g.text.hex};`),e.push("}","","/* Esempio d'uso */","body { background: var(--bg); color: var(--text); }",".btn-primary { background: var(--primary); color: var(--text); }",".btn-accent { background: var(--accent); color: var(--text); }"),e.join(`
`)}function K(){return JSON.stringify({palette:c.map(e=>({hex:e.hex,rgb:{r:e.r,g:e.g,b:e.b}})),roles:g?{bg:g.bg.hex,primary:g.primary.hex,accent:g.accent.hex,text:g.text.hex}:null},null,2)}function Z(e){const t=d("canvas"),n=t.getContext("2d"),a=Math.min(1,500/Math.max(e.width,e.height)),r=Math.max(1,Math.round(e.width*a)),s=Math.max(1,Math.round(e.height*a));t.width=r,t.height=s,n.drawImage(e,0,0,r,s);const{data:h}=n.getImageData(0,0,r,s),l=[],i=Math.max(1,Math.floor(r*s/6e3));let o=0,u=0;for(let f=0;f<h.length;f+=4*i){if(h[f+3]/255<.5)continue;const M=h[f],x=h[f+1],$=h[f+2];l.push({r:M,g:x,b:$}),o+=(M+x+$)/3,u++}return{pixels:l,w:r,h:s,avg:Math.round(o/Math.max(1,u))}}function B(e,t=6,n=12){if(!e.length)return[];const a=[],r=new Set;for(;a.length<t;){const l=Math.floor(Math.random()*e.length);r.has(l)||(r.add(l),a.push({...e[l]}))}let s=new Array(e.length).fill(0);for(let l=0;l<n;l++){for(let o=0;o<e.length;o++){const u=e[o];let f=0,M=1/0;for(let x=0;x<a.length;x++){const $=a[x],Q=(u.r-$.r)**2+(u.g-$.g)**2+(u.b-$.b)**2;Q<M&&(M=Q,f=x)}s[o]=f}const i=Array.from({length:t},()=>({r:0,g:0,b:0,count:0}));for(let o=0;o<e.length;o++){const u=e[o],f=i[s[o]];f.r+=u.r,f.g+=u.g,f.b+=u.b,f.count++}for(let o=0;o<t;o++)i[o].count>0&&(a[o]={r:Math.round(i[o].r/i[o].count),g:Math.round(i[o].g/i[o].count),b:Math.round(i[o].b/i[o].count)})}const h=Array.from({length:t},(l,i)=>({color:a[i],count:0}));return s.forEach(l=>h[l].count++),h.filter(l=>l.count>0).sort((l,i)=>i.count-l.count)}function tt(e){H.innerHTML="",c=e.map(t=>({...t.color,hex:L(t.color),count:t.count})),c.forEach((t,n)=>{const a=P(t.r,t.g,t.b),r=A(t),s=document.createElement("div");s.className="swatch",s.innerHTML=`
        <div class="chip" style="background:${t.hex}"></div>
        <div class="meta">
          <div class="row">
            <span class="badge">#${String(n+1).padStart(2,"0")}</span>
            <span class="badge" style="background:${t.hex};color:${r.hex}">Aa ${r.ratio.toFixed(1)}:1</span>
          </div>
          <div class="mt8 mono">
            ${t.hex.toUpperCase()} • rgb(${t.r}, ${t.g}, ${t.b}) • hsl(${a.h} ${a.s}% ${a.l}%)
          </div>
        </div>
      `,s.setAttribute("role","img"),s.setAttribute("aria-label",`${t.hex.toUpperCase()} — rgb(${t.r}, ${t.g}, ${t.b})`),H.appendChild(s)})}function et(){if(!c.length)return;const e=o=>P(o.r,o.g,o.b).h,t=(o,u)=>{const f=Math.abs(o-u);return Math.min(f,360-f)},n=c[0]||{hex:"#ffffff",r:255,g:255,b:255},a=c[1]||n,r=c.slice(2).length?c.slice(2):c;let s=r.filter(o=>t(e(o),e(n))>=25&&t(e(o),e(a))>=25);s.length||(s=r),s.sort((o,u)=>Math.abs(y(o,n)-4)-Math.abs(y(u,n)-4));const h=s[0]||a;let l=n,i=-1;for(const o of c){const u=y(o,n);L(o)!==L(n)&&u>i&&(i=u,l=o)}if(i<3){const o=A(n);l={hex:o.hex,r:o.rgb.r,g:o.rgb.g,b:o.rgb.b}}g={bg:n,primary:a,accent:h,text:l},["bg","primary","accent","text"].forEach(o=>{const u=I[o];u.querySelector(".chip-role").style.background=g[o].hex,u.querySelector(".role-hex").textContent=g[o].hex,u.querySelector(".chip-role").setAttribute("aria-label",`Colore ${o} ${g[o].hex}`)}),nt()}function nt(){if(!c.length||!g){b.innerHTML="";return}let e=[c[0],c[1]],t=0;for(let n=0;n<c.length;n++)for(let a=n+1;a<c.length;a++){const r=Math.sqrt((c[n].r-c[a].r)**2+(c[n].g-c[a].g)**2+(c[n].b-c[a].b)**2);r>t&&(t=r,e=[c[n],c[a]])}b.innerHTML="",b.appendChild(_("Contrasto forte",e[0].hex,e[1].hex,"I due colori più diversi della foto")),b.appendChild(_("Evidenza → Principale",g.accent.hex,g.primary.hex,"Dal colore di evidenza al principale"))}v==null||v.addEventListener("change",async e=>{const t=e.target.files&&e.target.files[0];t&&S(await V(t))}),p==null||p.addEventListener("dragover",e=>{e.preventDefault(),p.classList.add("dragover")}),p==null||p.addEventListener("dragleave",()=>p.classList.remove("dragover")),p==null||p.addEventListener("drop",async e=>{e.preventDefault(),p.classList.remove("dragover");const t=e.dataTransfer.files&&e.dataTransfer.files[0];t&&S(await V(t))}),p==null||p.addEventListener("keydown",e=>{e.key!=="Enter"&&e.key!==" "||(e.preventDefault(),v==null||v.click())}),k==null||k.addEventListener("click",async()=>{const e=w==null?void 0:w.querySelector("img");if(!e){m.textContent="Carica prima un'immagine (o usa la demo).";return}k.disabled=!0,m.textContent="Analizzo…";try{const{clusters:t}=await new Promise((n,a)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{var i;z.textContent=`${r.naturalWidth}×${r.naturalHeight}px`,S(e.src);const{pixels:s,avg:h}=Z(r);F.style.width=`${(h/255*100).toFixed(0)}%`,W.textContent=`${h} / 255`,(i=d("avg-bar-outer"))==null||i.setAttribute("aria-valuenow",String(h));const l=B(s,6,12);n({clusters:l})},r.onerror=a,r.src=e.src});tt(t),et(),m.textContent="Pronto!"}catch(t){console.error(t),m.textContent="Errore analisi immagine."}finally{k.disabled=!1}}),R==null||R.addEventListener("click",async()=>{if(!c.length){m.textContent="Genera la palette prima.";return}const e=J(),t=await T(e);m.textContent=t.ok?"CSS copiato ✅":"Copia bloccata. Download…",t.ok||C("palette.css",e)}),j==null||j.addEventListener("click",async()=>{if(!c.length){m.textContent="Genera la palette prima.";return}const e=K(),t=await T(e);m.textContent=t.ok?"JSON copiato ✅":"Copia bloccata. Download…",t.ok||C("palette.json",e)}),G==null||G.addEventListener("click",()=>{c.length&&C("palette.css",J())}),U==null||U.addEventListener("click",()=>{c.length&&C("palette.json",K())}),b==null||b.addEventListener("click",async e=>{const t=e.target.closest(".grad-pill");if(!t)return;const n=t.dataset.from,a=t.dataset.to,r=t.dataset.label||"Gradiente",s=`background: linear-gradient(90deg, ${n}, ${a});`,h=await T(s);m.textContent=h.ok?`Copiato: ${r} (${n} → ${a}) ✅`:"Copia bloccata. Download…",h.ok||C("gradient.css",s),t.classList.remove("flash"),t.offsetWidth,t.classList.add("flash")}),b==null||b.addEventListener("keydown",async e=>{if(e.key!=="Enter"&&e.key!==" ")return;const t=e.target.closest(".grad-pill");if(!t)return;e.preventDefault();const n=t.dataset.from,a=t.dataset.to,r=t.dataset.label||"Gradiente",s=`background: linear-gradient(90deg, ${n}, ${a});`,h=await T(s);m.textContent=h.ok?`Copiato: ${r} (${n} → ${a}) ✅`:"Copia bloccata. Download…",h.ok||C("gradient.css",s),t.classList.remove("flash"),t.offsetWidth,t.classList.add("flash")}),q==null||q.addEventListener("click",()=>{const e=['<svg xmlns="http://www.w3.org/2000/svg" width="800" height="500">','<defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">','<stop offset="0%" stop-color="#0ea5e9"/>','<stop offset="50%" stop-color="#22d3ee"/>','<stop offset="100%" stop-color="#a78bfa"/>',"</linearGradient></defs>",'<rect width="100%" height="100%" fill="url(#g1)"/>','<circle cx="200" cy="180" r="110" fill="#f59e0b"/>','<circle cx="520" cy="320" r="140" fill="#ef4444"/>',"</svg>"].join("");S("data:image/svg+xml;utf8,"+encodeURIComponent(e))}),O==null||O.addEventListener("click",()=>{var e;w.innerHTML='<span class="tiny">anteprima</span>',H.innerHTML=`<div class="hint">Carica un'immagine e premi “Estrai palette”.</div>`,z.textContent="—",F.style.width="0%",W.textContent="—",(e=d("avg-bar-outer"))==null||e.setAttribute("aria-valuenow","0"),b.innerHTML="",g=null,c=[],["bg","primary","accent","text"].forEach(t=>{I[t].querySelector(".role-hex").textContent="—",I[t].querySelector(".chip-role").style.background=""}),m.textContent="—"});try{console.assert(Math.round(y({r:0,g:0,b:0},{r:255,g:255,b:255}))===21,"CR black/white=21"),console.assert(L({r:16,g:32,b:48})==="#102030","hex ok"),E&&(E.textContent="Diagnostica: ok")}catch(e){E&&(E.textContent="Diagnostica: "+(e&&e.message?e.message:e))}}export{at as initPaletteExtractor};
